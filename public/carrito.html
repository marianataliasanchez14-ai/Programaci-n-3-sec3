<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Carrito - Patilla Shop üçâ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page"> <div class="catalog-card" style="max-width: 700px;">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <a href="dashboard.html" class="btn-secondary" style="width: auto; padding: 10px 20px;">‚Üê Seguir Comprando</a>
                <h1 style="color: #e91e63; margin: 0;">Mi Carrito üõí</h1>
            </div>
        </header>

        <div id="lista-carrito" style="margin-top: 20px;">
            </div>

        <div id="resumen-compra" style="margin-top: 30px; border-top: 2px solid rgba(233, 30, 99, 0.2); padding-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: #555;">Total a pagar:</h3>
                <h2 id="total-precio" style="color: #e91e63; font-size: 2rem;">$0.00</h2>
            </div>
            
            <button class="btn-primary" onclick="finalizarCompra()" style="margin-top: 20px; background: #27ae60;">
                Finalizar Pedido por WhatsApp üçâ
            </button>
            <p style="font-size: 0.8rem; color: #888; margin-top: 10px; text-align: center;">
                * Al finalizar, se enviar√° un resumen de tu pedido.
            </p>
        </div>
    </div>

   <script>
    async function cargarCarrito() {
        try {
            // 1. Llamamos a tu servidor Node.js (Base de datos Laragon)
            const res = await fetch('/cart'); 
            
            if (res.status === 401) {
                alert("Debes iniciar sesi√≥n para ver tu carrito üçâ");
                window.location.href = 'index.html';
                return;
            }
            
            const data = await res.json();
            const lista = document.getElementById('lista-carrito');
            const totalTxt = document.getElementById('total-precio');
            const resumen = document.getElementById('resumen-compra');

            // Si la tabla carrito en Laragon est√° vac√≠a para este usuario
            if (!data.items || data.items.length === 0) {
                lista.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <p style="font-size: 1.2rem; color: #888;">Tu carrito de Patilla Shop est√° vac√≠o... üçâ</p>
                        <br>
                        <a href="dashboard.html" class="btn-comprar" style="text-decoration:none; display:inline-block; width:auto; background:#e91e63; color:white; padding:10px 20px; border-radius:20px;">Ver Cat√°logo</a>
                    </div>`;
                totalTxt.innerText = "$0.00";
                resumen.style.display = 'none';
                return;
            }

            // 2. Si hay productos, los dibujamos
            lista.innerHTML = '';
            resumen.style.display = 'block';

            data.items.forEach((p) => {
                lista.innerHTML += `
                    <div class="cart-item" style="display: flex; align-items: center; background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <div style="flex-grow: 1; text-align: left; margin-left: 20px;">
                            <h4 style="margin: 0; color: #333;">${p.nombre}</h4>
                            <span style="color: #e91e63; font-weight: bold; font-size: 1.1rem;">$${p.precio} x ${p.cantidad}</span>
                        </div>

                        <button onclick="eliminarDelCarrito(${p.id})" 
                                style="background: #ffebee; border: none; color: #ff5252; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold;">
                            ‚úï
                        </button>
                    </div>
                `;
            });

            totalTxt.innerText = `$${data.total_pagar}`;

        } catch (error) {
            console.error("Error al cargar carrito:", error);
            alert("Error al conectar con la base de datos");
        }
    }

    // Funci√≥n para eliminar un producto de la tabla carrito
    async function eliminarDelCarrito(idCarrito) {
        if(!confirm("¬øQuitar este bikini del carrito? üçâ")) return;

        try {
            // Debes tener esta ruta en tu cart.js (router.delete('/:id'))
            const res = await fetch(`/cart/${idCarrito}`, { method: 'DELETE' });
            if(res.ok) {
                cargarCarrito(); // Recargamos la vista
            }
        } catch (e) { alert("No se pudo eliminar"); }
    }

    // 3. FINALIZAR COMPRA: Descuenta stock y vac√≠a tabla carrito
    async function finalizarCompra() {
        try {
            const res = await fetch('/cart/checkout', { method: 'POST' });
            
            if (res.ok) {
                const mensajeServidor = await res.text();
                alert(mensajeServidor); // "¬°Compra realizada con √©xito! Stock actualizado..."
                
                // Opcional: Redirigir a WhatsApp despu√©s de limpiar la DB
                // window.open('https://wa.me/TUNUMERO', '_blank');
                
                window.location.href = 'dashboard.html';
            } else {
                const err = await res.text();
                alert("Error: " + err);
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }

    window.onload = cargarCarrito;
   </script>
</body>
</html>