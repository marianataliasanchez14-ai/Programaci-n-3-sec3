<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Usuario - Patilla Shop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page">
    <div class="catalog-card">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="#" class="btn-secondary" style="width: auto; padding: 10px 20px;" onclick="confirmarSalida()">‚Üê Salir</a>
                
                <h1 style="color: #e91e63; font-size: 2.5rem;">Patilla Shop</h1>
                
                <a href="carrito.html" class="btn-secondary" style="width: auto; padding: 10px 20px;">
                    üõí Mi Carrito (<span id="count-carrito">0</span>)
                </a>
            </div>

            <h2 id="saludo-usuario" style="margin-top: 20px;">¬°Hola, Bienvenida! ‚ú®</h2>

            <div class="talla-info">
                <strong>‚ú® NOTA IMPORTANTE:</strong> Todos nuestros modelos son <strong>Talla √önica</strong>. 
                Se adaptan perfectamente desde una talla S hasta una <strong>talla L</strong>. ‚ú®
            </div>
        </header>

        <div class="catalogo-grid" id="catalogoGrid"></div>
    </div>

    <script>
 // 1. GESTI√ìN DE USUARIO Y SALUDO
    const usuarioLogueado = JSON.parse(localStorage.getItem('usuario'));
    const nombreSimple = localStorage.getItem('usuarioNombre');
    const displayNombre = (usuarioLogueado && usuarioLogueado.nombre) ? usuarioLogueado.nombre : (nombreSimple || "Invitada");
    
    document.getElementById('saludo-usuario').innerText = `¬°Hola, ${displayNombre}! ‚ú®`;

    // 2. CARGAR PRODUCTOS DESDE EL SERVIDOR
    async function cargarProductos() {
        try {
            const res = await fetch('/productos');
            const productos = await res.json();
            const grid = document.getElementById('catalogoGrid');
            grid.innerHTML = '';

            productos.forEach(p => {
                const estaAgotado = p.stock <= 0;

                grid.innerHTML += `
                    <div class="producto-item">
                        <div class="img-container">
                            <img src="${p.imagen}" alt="${p.nombre}" onerror="this.src='https://via.placeholder.com/300x400?text=Patilla+Shop'">
                        </div>
                        <div class="producto-info">
                            <span style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Ref: ${p.codigo}</span>
                            <h3>${p.nombre}</h3>
                            <p class="producto-precio">$${p.precio}</p>
                            
                            ${estaAgotado ? 
                                '<p style="color:red; font-weight:bold; font-size:0.8rem;">AGOTADO</p>' : 
                                `<p style="color:green; font-size:0.8rem; margin-bottom:10px;">Disponibles: ${p.stock}</p>`
                            }
                            
                            <button class="btn-comprar" ${estaAgotado ? 'disabled' : ''} 
                                    onclick="a√±adirAlCarrito(${p.id}, '${p.nombre}')">
                                ${estaAgotado ? 'Agotado' : 'A√±adir al Carrito üçâ'}
                            </button>
                        </div>
                    </div>
                `;
            });
            actualizarContador();
        } catch (e) { 
            console.error("Error al cargar productos:", e); 
        }
    }

    // 3. L√ìGICA DEL CARRITO (CONEXI√ìN A BASE DE DATOS)
    async function a√±adirAlCarrito(producto_id, nombre) {
        try {
            const res = await fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    producto_id: producto_id, 
                    cantidad: 1 
                })
            });

            if (res.ok) {
                alert(`¬°${nombre} a√±adido a tu carrito en Patilla Shop! üçâ`);
                actualizarContador();
            } else if (res.status === 401) {
                alert("Debes iniciar sesi√≥n para comprar.");
                window.location.href = '/';
            } else {
                alert("Hubo un problema al a√±adir el producto.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error de conexi√≥n con el servidor");
        }
    }

    // El contador ahora tambi√©n debe consultar a la base de datos
    async function actualizarContador() {
        try {
            const res = await fetch('/cart');
            const data = await res.json();
            const totalItems = data.items ? data.items.length : 0;
            document.getElementById('count-carrito').innerText = totalItems;
        } catch (e) {
            document.getElementById('count-carrito').innerText = "0";
        }
    }

    // 4. CERRAR SESI√ìN
    function confirmarSalida() {
        if(confirm("¬øEst√°s seguro de que quieres salir?")) {
            localStorage.clear(); // Limpia todo para seguridad
            window.location.href = '/'; 
        }
    }

    window.onload = cargarProductos;
    </script>
</body>
</html>