<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Patilla Shop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body">

    <div class="admin-container">
        <nav class="admin-nav" style="text-align: center; margin-bottom: 20px;">
            <a href="dashboard.html" style="text-decoration: none; color: #e91e63; font-weight: bold;">‚Üê Ver el Catalogo</a>
        </nav>
        
        <header style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #333; font-size: 2.5rem;">Gesti√≥n de Productos üçâ</h1>
            <p style="color: #666;">Administra los trajes de ba√±o y stock de forma centralizada.</p>
        </header>

        <section class="admin-card">
            <h3 id="formTitulo" style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #fce4ec; padding-bottom: 10px;">A√±adir Nuevo Modelo</h3>
            
            <form id="formProducto" class="form-grid-vertical">
                <div class="input-block">
                    <label>Nombre del Producto:</label>
                    <input type="text" id="nombre" placeholder="Ej: Bikini Tri√°ngulo Ne√≥n" required>
                </div>

                <div class="input-block">
                    <label>C√≥digo (SKU):</label>
                    <input type="text" id="codigo" placeholder="SW-001" required>
                </div>

                <div class="input-block">
                    <label>Precio ($):</label>
                    <input type="number" id="precio" step="0.01" min="0.01" placeholder="0.00" required>
                </div>

                <div class="input-block">
                    <label>Stock:</label>
                    <input type="number" id="stock" min="0" value="0" required>
                </div>
                
                <div class="input-block" style="grid-column: span 2;">
                    <label>Foto del Traje de Ba√±o:</label>
                    <input type="file" id="imagen" accept="image/*" style="border: none; background: none;">
                </div>

                <div class="input-block" style="grid-column: span 2;">
                    <label>Descripci√≥n:</label>
                    <textarea id="descripcion" rows="3" placeholder="Ej: Conjunto de 2 piezas..."></textarea>
                </div>

                <button type="submit" id="btnAccion" class="btn-guardar" style="grid-column: span 2;">Guardar Producto</button>
                <button type="button" id="btnCancelar" style="display:none; background:#ccc; grid-column: span 2;" class="btn-guardar" onclick="cancelarEdicion()">Cancelar Edici√≥n</button>
            </form>
        </section>

        <div class="search-box-container" style="margin: 30px auto; display: flex; justify-content: center; align-items: center; gap: 15px; background: white; padding: 15px; border-radius: 50px; width: fit-content; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <span style="font-size: 1.2rem;">üîç</span>
            <input type="text" id="buscadorCodigo" placeholder="Buscar por c√≥digo..." 
                   style="border: none; outline: none; font-size: 1rem; width: 250px; background: white !important;">
        </div>

        <section class="admin-card">
            <h3 style="margin-bottom: 20px;">Inventario de Trajes de Ba√±o</h3>
            <div class="table-container">
                <table id="tablaProductos" class="admin-table">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        let editando = false;

        async function cargarProductos() {
            try {
                const res = await fetch('/productos');
                const productos = await res.json();
                const tbody = document.querySelector('#tablaProductos tbody');
                tbody.innerHTML = '';
                
                productos.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td><img src="${p.imagen}" style="width:50px; height:50px; object-fit:cover; border-radius:8px;"></td>
                            <td><strong>${p.codigo}</strong></td>
                            <td>${p.nombre}</td>
                            <td>$${p.precio}</td>
                            <td>${p.stock > 0 ? p.stock : '<span style="color:red; font-weight:bold;">Agotado</span>'}</td>
                            <td>
                                <button onclick="prepararEdicion('${p.codigo}', '${p.nombre}', ${p.precio}, ${p.stock}, '${p.descripcion}')" style="background:#2196F3; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold; margin-right:5px;">Editar</button>
                                <button onclick="eliminarProducto('${p.codigo}')" style="background:#ff5252; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold;">Borrar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error("Error:", e); }
        }

        function prepararEdicion(codigo, nombre, precio, stock, descripcion) {
            editando = true;
            document.getElementById('formTitulo').innerText = "Editando: " + codigo;
            document.getElementById('codigo').value = codigo;
            document.getElementById('codigo').disabled = true;
            document.getElementById('nombre').value = nombre;
            document.getElementById('precio').value = precio;
            document.getElementById('stock').value = stock;
            document.getElementById('descripcion').value = descripcion;
            
            document.getElementById('btnAccion').innerText = "Actualizar Cambios üçâ";
            document.getElementById('btnAccion').style.background = "#2196F3";
            document.getElementById('btnCancelar').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelarEdicion() {
            editando = false;
            document.getElementById('formProducto').reset();
            document.getElementById('codigo').disabled = false;
            document.getElementById('formTitulo').innerText = "A√±adir Nuevo Modelo";
            document.getElementById('btnAccion').innerText = "Guardar Producto";
            document.getElementById('btnAccion').style.background = "#e91e63";
            document.getElementById('btnCancelar').style.display = "none";
        }

        document.getElementById('formProducto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('nombre', document.getElementById('nombre').value);
            formData.append('codigo', document.getElementById('codigo').value);
            formData.append('precio', document.getElementById('precio').value);
            formData.append('stock', document.getElementById('stock').value);
            formData.append('descripcion', document.getElementById('descripcion').value);
            
            const inputImg = document.getElementById('imagen');
            if (inputImg.files[0]) formData.append('imagen', inputImg.files[0]);

            const url = editando ? `/productos/${document.getElementById('codigo').value}` : '/productos';
            const method = editando ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, body: formData });
                if (res.ok) {
                    alert('¬°Operaci√≥n exitosa! üçâ');
                    cancelarEdicion();
                    cargarProductos();
                } else{
                    const errorTexto = await res.text();
                    alert('Error: '+ errorTexto);
                }
            } catch (error) { alert('Error de conexi√≥n'); }
        });

        async function eliminarProducto(codigo) {
            if (!confirm('¬øEliminar este producto?')) return;
            await fetch(`/productos/${codigo}`, { method: 'DELETE' });
            cargarProductos();
        }

        document.getElementById('buscadorCodigo').addEventListener('keyup', function() {
            const busqueda = this.value.toLowerCase();
            const filas = document.querySelectorAll('#tablaProductos tbody tr');
            filas.forEach(f => {
                const texto = f.querySelector('td:nth-child(2)').innerText.toLowerCase();
                f.style.display = texto.includes(busqueda) ? '' : 'none';
            });
        });

        cargarProductos();
    </script>
</body>
</html>